<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Services - SimpleWatch</title>
    <link rel="stylesheet" href="/static/css/theme.css">
    <link rel="stylesheet" href="/static/css/services.css">
    <link rel="stylesheet" href="/static/css/maintenance.css">
    <link rel="stylesheet" href="/static/css/ai-sre.css">
</head>
<body>
    <div id="navigation" data-page="services"></div>

    <div class="main-container">
        <div class="page-header">
            <div>
                <h1 class="page-title">Services & Monitors</h1>
                <p style="color: var(--text-secondary); margin-top: 0.5rem;">Manage your monitoring services and checks</p>
            </div>
            <div class="action-buttons">
                <button onclick="showAddServiceModal()" class="btn btn-secondary">+ Add Service</button>
                <button onclick="openMonitorModal(MonitorModalMode.CREATE_WITH_SERVICE)" class="btn btn-export" id="quickMonitorBtn">
                    Quick Monitor
                </button>
            </div>
        </div>

        <div id="servicesList"></div>
    </div>

    <!-- Add Service Modal -->
    <div id="addServiceModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Add Service</h3>
            </div>
            <form id="addServiceForm">
                <div class="form-group">
                    <label class="form-label">Service Name</label>
                    <input type="text" id="serviceName" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea id="serviceDescription" class="form-input" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Category</label>
                    <input type="text" id="serviceCategory" class="form-input">
                </div>

                <!-- SLA Configuration (Optional) -->
                <div style="border-top: 1px solid var(--border-color); margin-top: 1.5rem; padding-top: 1.5rem;">
                    <h4 style="font-weight: 600; margin-bottom: 0.75rem; font-size: 0.9rem; color: var(--text-secondary);">
                        SLA Target
                    </h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label class="form-label">Target Uptime (%)</label>
                            <input type="number" id="serviceSlaTarget" class="form-input" placeholder="99.9" step="0.01" min="0" max="100">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Timeframe</label>
                            <select id="serviceSlaTimeframe" class="form-input">
                                <option value="">Not configured</option>
                                <option value="7">7 days</option>
                                <option value="30" selected>30 days</option>
                                <option value="90">90 days</option>
                                <option value="365">365 days</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                    <button type="submit" class="btn btn-primary" style="flex: 1;">Create</button>
                    <button type="button" onclick="hideAddServiceModal()" class="btn btn-secondary" style="flex: 1;">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Service Modal -->
    <div id="editServiceModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Edit Service</h3>
            </div>
            <form id="editServiceForm">
                <input type="hidden" id="editServiceId">
                <div class="form-group">
                    <label class="form-label">Service Name</label>
                    <input type="text" id="editServiceName" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea id="editServiceDescription" class="form-input" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Category</label>
                    <input type="text" id="editServiceCategory" class="form-input">
                </div>

                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="editShowOnStatusPage" class="form-checkbox">
                        <span>Show on public status page</span>
                    </label>
                    <p class="form-hint">When enabled, this service will be visible on the public status page at /status</p>
                </div>

                <!-- SLA Configuration Section -->
                <div style="border-top: 1px solid var(--border-color); margin-top: 2rem; padding-top: 2rem;">
                    <h4 style="font-weight: 700; margin-bottom: 1rem; color: var(--text-primary);">
                        SLA Target
                    </h4>
                    <p class="form-hint" style="margin-top: -0.5rem; margin-bottom: 1rem;">Configure an uptime target to track compliance. A badge will appear next to uptime showing SLA status.</p>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label class="form-label">Target Uptime (%)</label>
                            <input type="number" id="editSlaTarget" class="form-input" placeholder="99.9" step="0.01" min="0" max="100">
                            <p class="form-hint">Leave empty to disable SLA tracking</p>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Timeframe</label>
                            <select id="editSlaTimeframe" class="form-input">
                                <option value="">Not configured</option>
                                <option value="7">7 days</option>
                                <option value="30">30 days</option>
                                <option value="90">90 days</option>
                                <option value="365">365 days</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Notification Settings Section -->
                <div style="border-top: 1px solid var(--border-color); margin-top: 2rem; padding-top: 2rem;">
                    <h4 style="font-weight: 700; margin-bottom: 1rem; color: var(--text-primary);">
                        Notification Settings
                    </h4>

                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="editNotificationsEnabled" class="form-checkbox" checked>
                            <span>Enable notifications for this service</span>
                        </label>
                    </div>

                    <div id="notificationSettingsContent">
                        <div class="form-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="editEmailEnabled" class="form-checkbox">
                                <span>Send email notifications</span>
                            </label>
                        </div>

                        <div class="form-group" id="emailRecipientsGroup" style="display: none;">
                            <label class="form-label">Email Recipients (comma-separated)</label>
                            <input type="text" id="editEmailRecipients" class="form-input" placeholder="admin@example.com, ops@example.com">
                        </div>

                        <div class="form-group">
                            <label class="form-label">Webhook Channels</label>
                            <div id="webhookChannelsList" style="font-size: 0.875rem; color: var(--text-secondary);">
                                Loading channels...
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Cooldown Period (minutes)</label>
                            <input type="number" id="editCooldownMinutes" class="form-input" value="5" min="1">
                            <div style="font-size: 0.75rem; color: var(--text-tertiary); margin-top: 0.5rem;">
                                Minimum time between notifications to prevent spam
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="editNotifyOnRecovery" class="form-checkbox" checked>
                                <span>Send recovery notifications</span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- AI Configuration Section -->
                <div id="aiConfigSection" style="border-top: 1px solid var(--border-color); margin-top: 2rem; padding-top: 2rem; display: none;">
                    <h4 style="font-weight: 700; margin-bottom: 0.5rem; color: var(--text-primary);">
                        AI Configuration
                    </h4>
                    <p class="form-hint" style="margin-bottom: 1rem;">Configure context and remediation webhooks for AI incident analysis</p>

                    <div class="form-group">
                        <label class="form-label">Service Context</label>
                        <textarea id="editServiceContext" class="form-input" rows="2" placeholder="e.g., Node.js API running on AWS ECS, port 3000, connects to PostgreSQL database..."></textarea>
                        <p class="form-hint">Help the AI understand what this service does and how it's deployed</p>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Known Issues</label>
                        <textarea id="editKnownIssues" class="form-input" rows="2" placeholder="e.g., Sometimes needs restart after memory exceeds 2GB. Database connection pool can exhaust under high load..."></textarea>
                        <p class="form-hint">Document common problems and their solutions for the AI to reference</p>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Remediation Webhooks</label>
                        <p class="form-hint" style="margin-bottom: 0.75rem;">Configure actions the AI can suggest when incidents occur</p>
                        <div id="remediationWebhooksList" class="webhook-list">
                            <!-- Populated dynamically -->
                        </div>
                        <button type="button" onclick="showAddWebhookForm()" class="btn btn-secondary btn-sm" style="margin-top: 0.5rem;">
                            + Add Webhook
                        </button>
                    </div>

                    <!-- Add Webhook Form (hidden by default) -->
                    <div id="addWebhookForm" class="webhook-form" style="display: none;">
                        <div class="webhook-form-header">
                            <span id="webhookFormTitle">Add Remediation Webhook</span>
                            <button type="button" onclick="hideWebhookForm()" class="btn-icon">&times;</button>
                        </div>
                        <input type="hidden" id="editWebhookIndex" value="-1">
                        <div class="form-group">
                            <label class="form-label">Action Name</label>
                            <input type="text" id="webhookName" class="form-input" placeholder="e.g., Restart Service">
                        </div>
                        <div style="display: grid; grid-template-columns: auto 1fr; gap: 0.75rem;">
                            <div class="form-group">
                                <label class="form-label">Method</label>
                                <select id="webhookMethod" class="form-input">
                                    <option value="POST">POST</option>
                                    <option value="GET">GET</option>
                                    <option value="PUT">PUT</option>
                                    <option value="DELETE">DELETE</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">URL</label>
                                <input type="url" id="webhookUrl" class="form-input" placeholder="https://api.example.com/restart">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Payload (JSON, optional)</label>
                            <textarea id="webhookPayload" class="form-input" rows="2" placeholder='{"action": "restart", "force": true}'></textarea>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Headers (JSON, optional)</label>
                            <textarea id="webhookHeaders" class="form-input" rows="2" placeholder='{"Authorization": "Bearer token123"}'></textarea>
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button type="button" onclick="saveWebhook()" class="btn btn-primary btn-sm">Save Webhook</button>
                            <button type="button" onclick="hideWebhookForm()" class="btn btn-secondary btn-sm">Cancel</button>
                        </div>
                    </div>
                </div>

                <div style="display: flex; gap: 1rem;">
                    <button type="submit" class="btn btn-primary" style="flex: 1;">Update</button>
                    <button type="button" onclick="hideEditServiceModal()" class="btn btn-secondary" style="flex: 1;">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Unified Monitor Modal -->
    <div id="unifiedMonitorModal" class="modal hidden">
        <div class="modal-content large">
            <div class="modal-header">
                <div>
                    <h3 class="modal-title" id="monitorModalTitle">Monitor Setup</h3>
                    <p class="modal-subtitle" id="monitorModalSubtitle"></p>
                </div>
            </div>
            <div id="monitorModalContent">
                <!-- Content will be dynamically rendered by monitor-modal.js -->
            </div>
        </div>
    </div>

    <script src="/static/js/components.js"></script>
    <script src="/static/js/theme.js"></script>
    <script src="/static/js/api.js"></script>
    <script src="/static/js/auth.js"></script>
    <script src="/static/js/nav.js"></script>

    <!-- Monitor Plugin System -->
    <script type="module">
        import monitorRegistry from '/static/js/monitors/registry.js';

        // Initialize plugin system on page load
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // Load all monitor plugins
                await monitorRegistry.loadMonitors();

                // Dispatch event to signal plugins are ready
                window.dispatchEvent(new CustomEvent('monitorPluginsLoaded'));
            } catch (error) {
                console.error('Failed to initialize monitor plugin system:', error);
            }
        });
    </script>

    <script>
        // Toggle category expansion
        function toggleCategory(categoryId, event) {
            // Prevent event bubbling to avoid interfering with modal clicks
            if (event) {
                event.stopPropagation();
            }

            const categoryContent = document.getElementById(`category-${categoryId}`);
            if (!categoryContent) {
                console.error('Category content not found:', `category-${categoryId}`);
                return;
            }

            const categoryHeader = categoryContent.previousElementSibling;

            if (categoryContent.classList.contains('expanded')) {
                categoryContent.classList.remove('expanded');
                categoryHeader.removeAttribute('data-expanded');
            } else {
                categoryContent.classList.add('expanded');
                categoryHeader.setAttribute('data-expanded', 'true');
            }
        }
    </script>

    <script src="/static/js/maintenance.js"></script>
    <script src="/static/js/services.js"></script>
</body>
</html>
