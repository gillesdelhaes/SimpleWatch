<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Services - SimpleWatch</title>
    <link rel="stylesheet" href="/static/css/theme.css">
    <style>
        .main-container { max-width: 1400px; margin: 0 auto; padding: 3rem 2rem; }
        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 3rem; }
        .page-title { font-size: 2.5rem; font-weight: 700; background: linear-gradient(135deg, var(--text-primary), var(--text-secondary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .action-buttons { display: flex; gap: 1rem; }

        /* Service cards */
        .service-card { background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 1rem; padding: 1.5rem; margin-bottom: 1.5rem; transition: all var(--transition-normal); }
        .service-card:hover { border-color: var(--border-hover); box-shadow: var(--shadow-md); }
        .service-header { display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem; }
        .service-title { font-size: 1.5rem; font-weight: 700; color: var(--text-primary); }
        .service-actions { display: flex; gap: 0.5rem; }
        .service-description { color: var(--text-secondary); margin-bottom: 1rem; }
        .service-meta { display: flex; gap: 2rem; margin-bottom: 1rem; font-size: 0.875rem; color: var(--text-tertiary); }

        /* Monitor list */
        .monitors-section { border-top: 1px solid var(--border-color); padding-top: 1rem; }
        .monitors-title { font-weight: 700; color: var(--text-secondary); text-transform: uppercase; font-size: 0.875rem; letter-spacing: 0.05em; margin-bottom: 1rem; }
        .monitor-item { background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 0.75rem; padding: 1rem; margin-bottom: 0.75rem; display: flex; justify-content: space-between; align-items: center; transition: all var(--transition-normal); }
        .monitor-item:hover { border-color: var(--border-hover); box-shadow: var(--shadow-sm); }
        .monitor-info { flex: 1; }
        .monitor-type { font-weight: 700; color: var(--text-primary); margin-bottom: 0.25rem; }
        .monitor-config { font-size: 0.875rem; color: var(--text-secondary); font-family: var(--font-mono); word-break: break-all; }
        .monitor-interval { font-size: 0.75rem; color: var(--text-tertiary); text-transform: uppercase; }
        .monitor-actions { display: flex; gap: 0.5rem; }

        /* Icon buttons */
        .icon-btn { background: none; border: none; padding: 0.5rem; cursor: pointer; color: var(--text-secondary); transition: all var(--transition-normal); border-radius: 0.5rem; }
        .icon-btn:hover { color: var(--accent-primary); background: var(--bg-tertiary); }
        .icon-btn.delete:hover { color: var(--status-down); }

        /* Form styling */
        .form-group { margin-bottom: 1.5rem; }
        .form-label { display: block; margin-bottom: 0.5rem; font-weight: 600; font-size: 0.875rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.05em; }
        .form-input { width: 100%; padding: 0.75rem 1rem; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 0.5rem; color: var(--text-primary); transition: all var(--transition-normal); }
        .form-input:focus { outline: none; border-color: var(--accent-primary); box-shadow: 0 0 0 3px var(--accent-glow); }
        .form-hint { font-size: 0.75rem; color: var(--text-tertiary); margin-top: 0.25rem; }

        /* Modal specific styles */
        .modal { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(8px); display: flex; align-items: center; justify-content: center; z-index: 1000; animation: fadeIn var(--transition-normal); }
        .modal-content { background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 1.5rem; padding: 2rem; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto; box-shadow: var(--shadow-lg); animation: scaleIn var(--transition-normal); }
        .modal-content.large { max-width: 800px; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 2px solid var(--border-color); }
        .modal-title { font-size: 1.5rem; font-weight: 700; }
        .modal-subtitle { color: var(--text-secondary); font-size: 0.875rem; margin-top: 0.25rem; }

        /* Monitor type selection */
        .type-grid { display: grid; gap: 1rem; margin-bottom: 1.5rem; }
        .type-card { padding: 1.25rem; background: var(--bg-primary); border: 2px solid var(--border-color); border-radius: 0.75rem; cursor: pointer; transition: all var(--transition-normal); }
        .type-card:hover { border-color: var(--accent-primary); box-shadow: var(--shadow-glow); transform: translateY(-2px); }
        .type-card-title { font-weight: 700; color: var(--text-primary); margin-bottom: 0.5rem; }
        .type-card-desc { font-size: 0.875rem; color: var(--text-secondary); }

        .hidden { display: none !important; }
    </style>
</head>
<body>
    <div id="navigation" data-page="services"></div>

    <div class="main-container">
        <div class="page-header">
            <div>
                <h1 class="page-title">Services & Monitors</h1>
                <p style="color: var(--text-secondary); margin-top: 0.5rem;">Manage your monitoring services and checks</p>
            </div>
            <div class="action-buttons">
                <button onclick="showAddServiceModal()" class="btn btn-secondary">+ Add Service</button>
                <button onclick="showQuickMonitorModal()" class="btn btn-primary">‚ö° Quick Monitor</button>
            </div>
        </div>

        <div id="servicesList"></div>
    </div>

    <!-- Add Service Modal -->
    <div id="addServiceModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Add Service</h3>
            </div>
            <form id="addServiceForm">
                <div class="form-group">
                    <label class="form-label">Service Name</label>
                    <input type="text" id="serviceName" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea id="serviceDescription" class="form-input" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Category</label>
                    <input type="text" id="serviceCategory" class="form-input">
                </div>
                <div style="display: flex; gap: 1rem;">
                    <button type="submit" class="btn btn-primary" style="flex: 1;">Create</button>
                    <button type="button" onclick="hideAddServiceModal()" class="btn btn-secondary" style="flex: 1;">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Service Modal -->
    <div id="editServiceModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Edit Service</h3>
            </div>
            <form id="editServiceForm">
                <input type="hidden" id="editServiceId">
                <div class="form-group">
                    <label class="form-label">Service Name</label>
                    <input type="text" id="editServiceName" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea id="editServiceDescription" class="form-input" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Category</label>
                    <input type="text" id="editServiceCategory" class="form-input">
                </div>
                <div style="display: flex; gap: 1rem;">
                    <button type="submit" class="btn btn-primary" style="flex: 1;">Update</button>
                    <button type="button" onclick="hideEditServiceModal()" class="btn btn-secondary" style="flex: 1;">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Quick Monitor Modal -->
    <div id="quickMonitorModal" class="modal hidden">
        <div class="modal-content large">
            <div class="modal-header">
                <div>
                    <h3 class="modal-title">Quick Monitor Setup</h3>
                    <p class="modal-subtitle">Create a service and monitor in one step</p>
                </div>
            </div>

            <div id="monitorTypeSelection">
                <h4 style="font-weight: 700; margin-bottom: 1rem; color: var(--text-primary);">Select Monitor Type</h4>
                <div class="type-grid">
                    <div class="type-card" onclick="selectMonitorType('website')">
                        <div class="type-card-title">üåê Website Monitor</div>
                        <div class="type-card-desc">Check if a URL responds</div>
                    </div>
                    <div class="type-card" onclick="selectMonitorType('api')">
                        <div class="type-card-title">üîå API Monitor</div>
                        <div class="type-card-desc">Call API endpoint with validation</div>
                    </div>
                    <div class="type-card" onclick="selectMonitorType('metric_threshold')">
                        <div class="type-card-title">üìä Metric Threshold</div>
                        <div class="type-card-desc">Receive numbers, alert on thresholds</div>
                    </div>
                    <div class="type-card" onclick="selectMonitorType('port')">
                        <div class="type-card-title">üîå Port Monitor</div>
                        <div class="type-card-desc">Test if TCP port is open</div>
                    </div>
                    <div class="type-card" onclick="selectMonitorType('deadman')">
                        <div class="type-card-title">üíÄ Deadman Monitor</div>
                        <div class="type-card-desc">Alert if no heartbeat received</div>
                    </div>
                </div>
                <button onclick="hideQuickMonitorModal()" class="btn btn-secondary" style="width: 100%;">Cancel</button>
            </div>

            <!-- Website Monitor Form -->
            <div id="websiteMonitorForm" class="hidden">
                <button onclick="backToMonitorSelection()" class="btn btn-secondary" style="margin-bottom: 1rem;">‚Üê Back</button>
                <h4 style="font-weight: 700; margin-bottom: 1rem;">Website Monitor Configuration</h4>
                <div class="form-group">
                    <label class="form-label">Service Name</label>
                    <input type="text" id="websiteServiceName" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Website URL</label>
                    <input type="url" id="websiteUrl" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Check Interval</label>
                    <select id="websiteInterval" class="form-input">
                        <option value="1">Every 1 minute</option>
                        <option value="5" selected>Every 5 minutes</option>
                        <option value="15">Every 15 minutes</option>
                        <option value="30">Every 30 minutes</option>
                        <option value="60">Every 60 minutes</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Timeout (seconds)</label>
                    <input type="number" id="websiteTimeout" value="10" class="form-input">
                </div>
                <button onclick="createWebsiteMonitor()" class="btn btn-primary" style="width: 100%;">Create Website Monitor</button>
            </div>

            <!-- API Monitor Form -->
            <div id="apiMonitorForm" class="hidden">
                <button onclick="backToMonitorSelection()" class="btn btn-secondary" style="margin-bottom: 1rem;">‚Üê Back</button>
                <h4 style="font-weight: 700; margin-bottom: 1rem;">API Monitor Configuration</h4>
                <div class="form-group">
                    <label class="form-label">Service Name</label>
                    <input type="text" id="apiServiceName" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">API URL</label>
                    <input type="url" id="apiUrl" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">HTTP Method</label>
                    <select id="apiMethod" class="form-input">
                        <option value="GET">GET</option>
                        <option value="POST">POST</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Expected Status Code</label>
                    <input type="number" id="apiStatusCode" value="200" class="form-input">
                </div>
                <div class="form-group">
                    <label class="form-label">Check Interval</label>
                    <select id="apiInterval" class="form-input">
                        <option value="1">Every 1 minute</option>
                        <option value="5" selected>Every 5 minutes</option>
                        <option value="15">Every 15 minutes</option>
                        <option value="30">Every 30 minutes</option>
                        <option value="60">Every 60 minutes</option>
                    </select>
                </div>
                <button onclick="createApiMonitor()" class="btn btn-primary" style="width: 100%;">Create API Monitor</button>
            </div>

            <!-- Metric Monitor Form -->
            <div id="metricMonitorForm" class="hidden">
                <button onclick="backToMonitorSelection()" class="btn btn-secondary" style="margin-bottom: 1rem;">‚Üê Back</button>
                <h4 style="font-weight: 700; margin-bottom: 1rem;">Metric Threshold Configuration</h4>
                <div class="form-group">
                    <label class="form-label">Service Name</label>
                    <input type="text" id="metricServiceName" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Monitor Name (Optional)</label>
                    <input type="text" id="metricMonitorName" class="form-input" placeholder="e.g., cpu, memory, disk">
                    <p class="form-hint">Used when posting metrics. Required for multiple metric monitors per service.</p>
                </div>
                <div class="form-group">
                    <label class="form-label">Warning Threshold</label>
                    <input type="number" step="0.1" id="metricWarning" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Critical Threshold</label>
                    <input type="number" step="0.1" id="metricCritical" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Comparison Type</label>
                    <select id="metricComparison" class="form-input">
                        <option value="greater">Greater than (>)</option>
                        <option value="less">Less than (<)</option>
                    </select>
                </div>
                <div class="code-example">
                    <div class="code-example-title">üì° How to send metric values</div>
                    <div class="code-block">curl -X POST http://localhost:5050/api/v1/metric/<span id="quickMetricServicePreview">SERVICE_NAME</span> \<br>  -H "Content-Type: application/json" \<br>  -d '{<br>    "api_key": "YOUR_API_KEY",<br>    "value": 87.5<br>  }'</div>
                    <p class="form-hint" style="margin-top: 0.5rem;">Replace YOUR_API_KEY with your actual API key from Settings page</p>
                </div>
                <button onclick="createMetricMonitor()" class="btn btn-primary" style="width: 100%;">Create Metric Monitor</button>
            </div>

            <!-- Port Monitor Form -->
            <div id="portMonitorForm" class="hidden">
                <button onclick="backToMonitorSelection()" class="btn btn-secondary" style="margin-bottom: 1rem;">‚Üê Back</button>
                <h4 style="font-weight: 700; margin-bottom: 1rem;">Port Monitor Configuration</h4>
                <div class="form-group">
                    <label class="form-label">Service Name</label>
                    <input type="text" id="portServiceName" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Host</label>
                    <input type="text" id="portHost" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Port</label>
                    <input type="number" id="portPort" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Check Interval</label>
                    <select id="portInterval" class="form-input">
                        <option value="1">Every 1 minute</option>
                        <option value="5" selected>Every 5 minutes</option>
                        <option value="15">Every 15 minutes</option>
                        <option value="30">Every 30 minutes</option>
                        <option value="60">Every 60 minutes</option>
                    </select>
                </div>
                <button onclick="createPortMonitor()" class="btn btn-primary" style="width: 100%;">Create Port Monitor</button>
            </div>

            <!-- Deadman Monitor Form -->
            <div id="deadmanMonitorForm" class="hidden">
                <button onclick="backToMonitorSelection()" class="btn btn-secondary" style="margin-bottom: 1rem;">‚Üê Back</button>
                <h4 style="font-weight: 700; margin-bottom: 1rem;">Deadman Monitor Configuration</h4>
                <div class="form-group">
                    <label class="form-label">Service Name</label>
                    <input type="text" id="deadmanServiceName" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Monitor Name (Optional)</label>
                    <input type="text" id="deadmanMonitorName" class="form-input" placeholder="e.g., backup, cron-job">
                    <p class="form-hint">Used when sending heartbeats. Required for multiple deadman monitors per service.</p>
                </div>
                <div class="form-group">
                    <label class="form-label">Expected Interval (hours)</label>
                    <input type="number" step="0.5" id="deadmanExpectedInterval" value="24" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Grace Period (hours)</label>
                    <input type="number" step="0.5" id="deadmanGracePeriod" value="1" class="form-input" required>
                </div>
                <div class="code-example">
                    <div class="code-example-title">üì° How to send heartbeats</div>
                    <div class="code-block">curl -X POST http://localhost:5050/api/v1/heartbeat/<span id="quickDeadmanServicePreview">SERVICE_NAME</span> \<br>  -H "Content-Type: application/json" \<br>  -d '{<br>    "api_key": "YOUR_API_KEY"<br>  }'</div>
                    <p class="form-hint" style="margin-top: 0.5rem;">Replace YOUR_API_KEY with your actual API key from Settings page</p>
                </div>
                <button onclick="createDeadmanMonitor()" class="btn btn-primary" style="width: 100%;">Create Deadman Monitor</button>
            </div>
        </div>
    </div>

    <!-- Add Monitor to Service Modal -->
    <div id="addMonitorToServiceModal" class="modal hidden">
        <div class="modal-content large">
            <div class="modal-header">
                <div>
                    <h3 class="modal-title">Add Monitor to Service</h3>
                    <p class="modal-subtitle">Service: <span id="targetServiceName"></span></p>
                </div>
            </div>
            <input type="hidden" id="targetServiceId">

            <div id="addMonitorTypeSelection">
                <h4 style="font-weight: 700; margin-bottom: 1rem; color: var(--text-primary);">Select Monitor Type</h4>
                <div class="type-grid">
                    <div class="type-card" onclick="selectAddMonitorType('website')">
                        <div class="type-card-title">üåê Website Monitor</div>
                        <div class="type-card-desc">Check if a URL responds</div>
                    </div>
                    <div class="type-card" onclick="selectAddMonitorType('api')">
                        <div class="type-card-title">üîå API Monitor</div>
                        <div class="type-card-desc">Call API endpoint with validation</div>
                    </div>
                    <div class="type-card" onclick="selectAddMonitorType('metric_threshold')">
                        <div class="type-card-title">üìä Metric Threshold</div>
                        <div class="type-card-desc">Receive numbers, alert on thresholds</div>
                    </div>
                    <div class="type-card" onclick="selectAddMonitorType('port')">
                        <div class="type-card-title">üîå Port Monitor</div>
                        <div class="type-card-desc">Test if TCP port is open</div>
                    </div>
                    <div class="type-card" onclick="selectAddMonitorType('deadman')">
                        <div class="type-card-title">üíÄ Deadman Monitor</div>
                        <div class="type-card-desc">Alert if no heartbeat received</div>
                    </div>
                </div>
                <button onclick="hideAddMonitorToServiceModal()" class="btn btn-secondary" style="width: 100%; margin-top: 1rem;">Cancel</button>
            </div>

            <!-- Add Website Monitor Form -->
            <div id="addWebsiteMonitorForm" class="hidden">
                <button onclick="backToAddMonitorSelection()" class="btn btn-secondary" style="margin-bottom: 1rem;">‚Üê Back</button>
                <h4 style="font-weight: 700; margin-bottom: 1rem;">Website Monitor Configuration</h4>
                <div class="form-group">
                    <label class="form-label">Website URL</label>
                    <input type="url" id="addWebsiteUrl" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Check Interval</label>
                    <select id="addWebsiteInterval" class="form-input">
                        <option value="1">Every 1 minute</option>
                        <option value="5" selected>Every 5 minutes</option>
                        <option value="15">Every 15 minutes</option>
                        <option value="30">Every 30 minutes</option>
                        <option value="60">Every 60 minutes</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Timeout (seconds)</label>
                    <input type="number" id="addWebsiteTimeout" value="10" class="form-input">
                </div>
                <button onclick="addWebsiteMonitorToService()" class="btn btn-primary" style="width: 100%;">Add Monitor</button>
            </div>

            <!-- Add API Monitor Form -->
            <div id="addApiMonitorForm" class="hidden">
                <button onclick="backToAddMonitorSelection()" class="btn btn-secondary" style="margin-bottom: 1rem;">‚Üê Back</button>
                <h4 style="font-weight: 700; margin-bottom: 1rem;">API Monitor Configuration</h4>
                <div class="form-group">
                    <label class="form-label">API URL</label>
                    <input type="url" id="addApiUrl" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">HTTP Method</label>
                    <select id="addApiMethod" class="form-input">
                        <option value="GET">GET</option>
                        <option value="POST">POST</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Expected Status Code</label>
                    <input type="number" id="addApiStatusCode" value="200" class="form-input">
                </div>
                <div class="form-group">
                    <label class="form-label">Check Interval</label>
                    <select id="addApiInterval" class="form-input">
                        <option value="1">Every 1 minute</option>
                        <option value="5" selected>Every 5 minutes</option>
                        <option value="15">Every 15 minutes</option>
                        <option value="30">Every 30 minutes</option>
                        <option value="60">Every 60 minutes</option>
                    </select>
                </div>
                <button onclick="addApiMonitorToService()" class="btn btn-primary" style="width: 100%;">Add Monitor</button>
            </div>

            <!-- Add Metric Monitor Form -->
            <div id="addMetricMonitorForm" class="hidden">
                <button onclick="backToAddMonitorSelection()" class="btn btn-secondary" style="margin-bottom: 1rem;">‚Üê Back</button>
                <h4 style="font-weight: 700; margin-bottom: 1rem;">Metric Threshold Configuration</h4>
                <div class="form-group">
                    <label class="form-label">Monitor Name (Optional)</label>
                    <input type="text" id="addMetricMonitorName" class="form-input" placeholder="e.g., cpu, memory, disk">
                    <p class="form-hint">Used when posting metrics. Required for multiple metric monitors per service.</p>
                </div>
                <div class="form-group">
                    <label class="form-label">Warning Threshold</label>
                    <input type="number" step="0.1" id="addMetricWarning" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Critical Threshold</label>
                    <input type="number" step="0.1" id="addMetricCritical" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Comparison Type</label>
                    <select id="addMetricComparison" class="form-input">
                        <option value="greater">Greater than (>)</option>
                        <option value="less">Less than (<)</option>
                    </select>
                </div>
                <div class="code-example">
                    <div class="code-example-title">üì° How to send metric values</div>
                    <div class="code-block">curl -X POST http://localhost:5050/api/v1/metric/<span id="addMetricServiceNamePreview">SERVICE_NAME</span> \<br>  -H "Content-Type: application/json" \<br>  -d '{<br>    "api_key": "YOUR_API_KEY",<br>    "value": 87.5<br>  }'</div>
                    <p class="form-hint" style="margin-top: 0.5rem;">Replace YOUR_API_KEY with your actual API key from Settings page</p>
                </div>
                <button onclick="addMetricMonitorToService()" class="btn btn-primary" style="width: 100%;">Add Monitor</button>
            </div>

            <!-- Add Port Monitor Form -->
            <div id="addPortMonitorForm" class="hidden">
                <button onclick="backToAddMonitorSelection()" class="btn btn-secondary" style="margin-bottom: 1rem;">‚Üê Back</button>
                <h4 style="font-weight: 700; margin-bottom: 1rem;">Port Monitor Configuration</h4>
                <div class="form-group">
                    <label class="form-label">Host</label>
                    <input type="text" id="addPortHost" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Port</label>
                    <input type="number" id="addPortNumber" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Check Interval</label>
                    <select id="addPortInterval" class="form-input">
                        <option value="5">Every 5 minutes</option>
                        <option value="15" selected>Every 15 minutes</option>
                        <option value="30">Every 30 minutes</option>
                        <option value="60">Every 60 minutes</option>
                    </select>
                </div>
                <button onclick="addPortMonitorToService()" class="btn btn-primary" style="width: 100%;">Add Monitor</button>
            </div>

            <!-- Add Deadman Monitor Form -->
            <div id="addDeadmanMonitorForm" class="hidden">
                <button onclick="backToAddMonitorSelection()" class="btn btn-secondary" style="margin-bottom: 1rem;">‚Üê Back</button>
                <h4 style="font-weight: 700; margin-bottom: 1rem;">Deadman Monitor Configuration</h4>
                <div class="form-group">
                    <label class="form-label">Monitor Name (Optional)</label>
                    <input type="text" id="addDeadmanMonitorName" class="form-input" placeholder="e.g., backup, cron-job">
                    <p class="form-hint">Used when sending heartbeats. Required for multiple deadman monitors per service.</p>
                </div>
                <div class="form-group">
                    <label class="form-label">Expected Interval (hours)</label>
                    <input type="number" step="0.5" id="addDeadmanExpectedInterval" value="24" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Grace Period (hours)</label>
                    <input type="number" step="0.5" id="addDeadmanGracePeriod" value="1" class="form-input" required>
                </div>
                <div class="code-example">
                    <div class="code-example-title">üì° How to send heartbeats</div>
                    <div class="code-block">curl -X POST http://localhost:5050/api/v1/heartbeat/<span id="addDeadmanServiceNamePreview">SERVICE_NAME</span> \<br>  -H "Content-Type: application/json" \<br>  -d '{<br>    "api_key": "YOUR_API_KEY"<br>  }'</div>
                    <p class="form-hint" style="margin-top: 0.5rem;">Replace YOUR_API_KEY with your actual API key from Settings page</p>
                </div>
                <button onclick="addDeadmanMonitorToService()" class="btn btn-primary" style="width: 100%;">Add Monitor</button>
            </div>
        </div>
    </div>

    <!-- Edit Website Monitor Modal -->
    <div id="editWebsiteMonitorModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Edit Website Monitor</h3>
            </div>
            <form id="editWebsiteMonitorForm">
                <input type="hidden" id="editWebsiteMonitorId">
                <div class="form-group">
                    <label class="form-label">Website URL</label>
                    <input type="url" id="editWebsiteUrl" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Check Interval</label>
                    <select id="editWebsiteInterval" class="form-input">
                        <option value="1">Every 1 minute</option>
                        <option value="5">Every 5 minutes</option>
                        <option value="15">Every 15 minutes</option>
                        <option value="30">Every 30 minutes</option>
                        <option value="60">Every 60 minutes</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Timeout (seconds)</label>
                    <input type="number" id="editWebsiteTimeout" class="form-input">
                </div>
                <div style="display: flex; gap: 1rem;">
                    <button type="submit" class="btn btn-primary" style="flex: 1;">Update</button>
                    <button type="button" onclick="hideEditMonitorModal()" class="btn btn-secondary" style="flex: 1;">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit API Monitor Modal -->
    <div id="editApiMonitorModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Edit API Monitor</h3>
            </div>
            <form id="editApiMonitorForm">
                <input type="hidden" id="editApiMonitorId">
                <div class="form-group">
                    <label class="form-label">API URL</label>
                    <input type="url" id="editApiUrl" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">HTTP Method</label>
                    <select id="editApiMethod" class="form-input">
                        <option value="GET">GET</option>
                        <option value="POST">POST</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Expected Status Code</label>
                    <input type="number" id="editApiStatusCode" class="form-input">
                </div>
                <div class="form-group">
                    <label class="form-label">Check Interval</label>
                    <select id="editApiInterval" class="form-input">
                        <option value="1">Every 1 minute</option>
                        <option value="5">Every 5 minutes</option>
                        <option value="15">Every 15 minutes</option>
                        <option value="30">Every 30 minutes</option>
                        <option value="60">Every 60 minutes</option>
                    </select>
                </div>
                <div style="display: flex; gap: 1rem;">
                    <button type="submit" class="btn btn-primary" style="flex: 1;">Update</button>
                    <button type="button" onclick="hideEditMonitorModal()" class="btn btn-secondary" style="flex: 1;">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Metric Monitor Modal -->
    <div id="editMetricMonitorModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Edit Metric Monitor</h3>
            </div>
            <form id="editMetricMonitorForm">
                <input type="hidden" id="editMetricMonitorId">
                <div class="form-group">
                    <label class="form-label">Monitor Name (Optional)</label>
                    <input type="text" id="editMetricMonitorName" class="form-input" placeholder="e.g., cpu, memory, disk">
                    <p class="form-hint">Used when posting metrics.</p>
                </div>
                <div class="form-group">
                    <label class="form-label">Warning Threshold</label>
                    <input type="number" step="0.1" id="editMetricWarning" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Critical Threshold</label>
                    <input type="number" step="0.1" id="editMetricCritical" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Comparison Type</label>
                    <select id="editMetricComparison" class="form-input">
                        <option value="greater">Greater than (>)</option>
                        <option value="less">Less than (<)</option>
                    </select>
                </div>
                <div class="code-example">
                    <div class="code-example-title">üì° How to send metric values</div>
                    <div class="code-block">curl -X POST http://localhost:5050/api/v1/metric/<span id="editMetricServiceNamePreview">SERVICE_NAME</span> \<br>  -H "Content-Type: application/json" \<br>  -d '{<br>    "api_key": "YOUR_API_KEY",<br>    "value": 87.5<br>  }'</div>
                    <p class="form-hint" style="margin-top: 0.5rem;">Replace YOUR_API_KEY with your actual API key from Settings page</p>
                </div>
                <div style="display: flex; gap: 1rem;">
                    <button type="submit" class="btn btn-primary" style="flex: 1;">Update</button>
                    <button type="button" onclick="hideEditMonitorModal()" class="btn btn-secondary" style="flex: 1;">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Port Monitor Modal -->
    <div id="editPortMonitorModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Edit Port Monitor</h3>
            </div>
            <form id="editPortMonitorForm">
                <input type="hidden" id="editPortMonitorId">
                <div class="form-group">
                    <label class="form-label">Host</label>
                    <input type="text" id="editPortHost" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Port</label>
                    <input type="number" id="editPortNumber" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Check Interval</label>
                    <select id="editPortInterval" class="form-input">
                        <option value="5">Every 5 minutes</option>
                        <option value="15">Every 15 minutes</option>
                        <option value="30">Every 30 minutes</option>
                        <option value="60">Every 60 minutes</option>
                    </select>
                </div>
                <div style="display: flex; gap: 1rem;">
                    <button type="submit" class="btn btn-primary" style="flex: 1;">Update</button>
                    <button type="button" onclick="hideEditMonitorModal()" class="btn btn-secondary" style="flex: 1;">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Deadman Monitor Modal -->
    <div id="editDeadmanMonitorModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Edit Deadman Monitor</h3>
            </div>
            <form id="editDeadmanMonitorForm">
                <input type="hidden" id="editDeadmanMonitorId">
                <div class="form-group">
                    <label class="form-label">Monitor Name (Optional)</label>
                    <input type="text" id="editDeadmanMonitorName" class="form-input" placeholder="e.g., backup, cron-job">
                    <p class="form-hint">Used when sending heartbeats.</p>
                </div>
                <div class="form-group">
                    <label class="form-label">Expected Interval (hours)</label>
                    <input type="number" step="0.5" id="editDeadmanExpectedInterval" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Grace Period (hours)</label>
                    <input type="number" step="0.5" id="editDeadmanGracePeriod" class="form-input" required>
                </div>
                <div class="code-example">
                    <div class="code-example-title">üì° How to send heartbeats</div>
                    <div class="code-block">curl -X POST http://localhost:5050/api/v1/heartbeat/<span id="editDeadmanServiceNamePreview">SERVICE_NAME</span> \<br>  -H "Content-Type: application/json" \<br>  -d '{<br>    "api_key": "YOUR_API_KEY"<br>  }'</div>
                    <p class="form-hint" style="margin-top: 0.5rem;">Replace YOUR_API_KEY with your actual API key from Settings page</p>
                </div>
                <div style="display: flex; gap: 1rem;">
                    <button type="submit" class="btn btn-primary" style="flex: 1;">Update</button>
                    <button type="button" onclick="hideEditMonitorModal()" class="btn btn-secondary" style="flex: 1;">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <script src="/static/js/theme.js"></script>
    <script src="/static/js/api.js"></script>
    <script src="/static/js/auth.js"></script>
    <script src="/static/js/nav.js"></script>
    <script>
        requireAuth();

        const userInfo = getUserInfo();

        // Load services
        async function loadServices() {
            try {
                const services = await api.listServices();
                const monitors = await api.listMonitors();

                // Group monitors by service_id
                const monitorsByService = {};
                monitors.forEach(monitor => {
                    if (!monitorsByService[monitor.service_id]) {
                        monitorsByService[monitor.service_id] = [];
                    }
                    monitorsByService[monitor.service_id].push(monitor);
                });

                const servicesList = document.getElementById('servicesList');

                if (services.length === 0) {
                    servicesList.innerHTML = '<div style="text-align: center; padding: 4rem; color: var(--text-secondary);"><h3 style="font-size: 1.5rem; margin-bottom: 1rem;">No services yet</h3><p>Create your first service using Quick Monitor or Add Service</p></div>';
                    return;
                }

                servicesList.innerHTML = services.map(service => {
                    const serviceMonitors = monitorsByService[service.id] || [];
                    return `
                    <div class="service-card">
                        <div class="service-header">
                            <div style="flex: 1;">
                                <h3 class="service-title">${service.name}</h3>
                                ${service.description ? `<p class="service-description">${service.description}</p>` : ''}
                                <div class="service-meta">
                                    ${service.category ? `<span>üìÅ ${service.category}</span>` : ''}
                                    <span>üîç ${serviceMonitors.length} monitor${serviceMonitors.length !== 1 ? 's' : ''}</span>
                                </div>
                            </div>
                            <div class="service-actions">
                                <button class="icon-btn" onclick="showEditServiceModal(${service.id}, '${service.name.replace(/'/g, "\\'")}', '${(service.description || '').replace(/'/g, "\\'")}', '${(service.category || '').replace(/'/g, "\\'")}')">
                                    <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20"><path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"></path></svg>
                                </button>
                                <button class="icon-btn delete" onclick="deleteService(${service.id})">
                                    <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg>
                                </button>
                            </div>
                        </div>
                        ${serviceMonitors.length > 0 ? `
                            <div class="monitors-section">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                    <h4 class="monitors-title">Monitors</h4>
                                    <button class="btn btn-secondary" style="padding: 0.5rem 1rem; font-size: 0.875rem;" onclick="showAddMonitorToServiceModal(${service.id}, '${service.name.replace(/'/g, "\\'")}')">+ Add Monitor</button>
                                </div>
                                ${serviceMonitors.map(monitor => `
                                    <div class="monitor-item">
                                        <div class="monitor-info">
                                            <div class="monitor-type">${getMonitorTypeName(monitor.monitor_type)}${monitor.config && monitor.config.name ? ` [${monitor.config.name}]` : ''}</div>
                                            <div class="monitor-config">${getMonitorDescription(monitor)}</div>
                                            <div class="monitor-interval">Every ${monitor.check_interval_minutes} minutes</div>
                                        </div>
                                        <div class="monitor-actions">
                                            <button class="icon-btn" onclick="editMonitor(${monitor.id})">
                                                <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20"><path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"></path></svg>
                                            </button>
                                            <button class="icon-btn delete" onclick="deleteMonitor(${monitor.id})">
                                                <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg>
                                            </button>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : `
                            <div class="monitors-section">
                                <p style="color: var(--text-tertiary); text-align: center; padding: 1rem;">No monitors configured</p>
                                <button class="btn btn-secondary" style="width: 100%;" onclick="showAddMonitorToServiceModal(${service.id}, '${service.name.replace(/'/g, "\\'")}')">+ Add First Monitor</button>
                            </div>
                        `}
                    </div>
                `;
                }).join('');
            } catch (error) {
                console.error('Failed to load services:', error);
            }
        }

        function getMonitorTypeName(type) {
            const names = {
                'website': 'üåê Website',
                'api': 'üîå API',
                'metric_threshold': 'üìä Metric',
                'port': 'üîå Port',
                'deadman': 'üíÄ Deadman'
            };
            return names[type] || type;
        }

        function getMonitorDescription(monitor) {
            if (!monitor.config) return '';
            const c = monitor.config;
            if (monitor.monitor_type === 'website') return c.url;
            if (monitor.monitor_type === 'api') return `${c.method || 'GET'} ${c.url}`;
            if (monitor.monitor_type === 'metric_threshold') return `Warning ${c.comparison === 'greater' ? '>' : '<'} ${c.warning_threshold}, Critical ${c.comparison === 'greater' ? '>' : '<'} ${c.critical_threshold}`;
            if (monitor.monitor_type === 'port') return `${c.host}:${c.port}`;
            if (monitor.monitor_type === 'deadman') return `Expect every ${c.expected_interval_hours}h (grace: ${c.grace_period_hours}h)`;
            return '';
        }

        // Modal functions
        function showAddServiceModal() { document.getElementById('addServiceModal').classList.remove('hidden'); }
        function hideAddServiceModal() { document.getElementById('addServiceModal').classList.add('hidden'); }
        function showQuickMonitorModal() { document.getElementById('quickMonitorModal').classList.remove('hidden'); }
        function hideQuickMonitorModal() {
            document.getElementById('quickMonitorModal').classList.add('hidden');
            backToMonitorSelection();
        }
        function showEditServiceModal(id, name, desc, cat) {
            document.getElementById('editServiceId').value = id;
            document.getElementById('editServiceName').value = name;
            document.getElementById('editServiceDescription').value = desc;
            document.getElementById('editServiceCategory').value = cat;
            document.getElementById('editServiceModal').classList.remove('hidden');
        }
        function hideEditServiceModal() { document.getElementById('editServiceModal').classList.add('hidden'); }

        function selectMonitorType(type) {
            document.getElementById('monitorTypeSelection').classList.add('hidden');

            // Map monitor type to form ID
            const formIds = {
                'website': 'websiteMonitorForm',
                'api': 'apiMonitorForm',
                'metric_threshold': 'metricMonitorForm',
                'port': 'portMonitorForm',
                'deadman': 'deadmanMonitorForm'
            };

            document.getElementById(formIds[type]).classList.remove('hidden');
        }

        function backToMonitorSelection() {
            document.getElementById('monitorTypeSelection').classList.remove('hidden');
            ['website', 'api', 'metric', 'port', 'deadman'].forEach(t => {
                document.getElementById(t + 'MonitorForm').classList.add('hidden');
            });
        }

        // Form submissions
        document.getElementById('addServiceForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                await api.createService({
                    name: document.getElementById('serviceName').value,
                    description: document.getElementById('serviceDescription').value,
                    category: document.getElementById('serviceCategory').value
                });
                hideAddServiceModal();
                e.target.reset();
                loadServices();
            } catch (error) {
                alert('Failed to create service: ' + error.message);
            }
        });

        document.getElementById('editServiceForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                const id = document.getElementById('editServiceId').value;
                await api.updateService(id, {
                    name: document.getElementById('editServiceName').value,
                    description: document.getElementById('editServiceDescription').value,
                    category: document.getElementById('editServiceCategory').value
                });
                hideEditServiceModal();
                loadServices();
            } catch (error) {
                alert('Failed to update service: ' + error.message);
            }
        });

        async function createWebsiteMonitor() {
            try {
                const serviceName = document.getElementById('websiteServiceName').value;
                const service = await api.createService({ name: serviceName, description: 'Website monitor', category: 'Monitor' });

                await api.createMonitor({
                    service_id: service.id,
                    monitor_type: 'website',
                    config: {
                        url: document.getElementById('websiteUrl').value,
                        timeout_seconds: parseInt(document.getElementById('websiteTimeout').value),
                        follow_redirects: true,
                        verify_ssl: true
                    },
                    check_interval_minutes: parseInt(document.getElementById('websiteInterval').value)
                });

                hideQuickMonitorModal();
                loadServices();
            } catch (error) {
                alert('Failed to create monitor: ' + error.message);
            }
        }

        async function createApiMonitor() {
            try {
                const serviceName = document.getElementById('apiServiceName').value;
                const service = await api.createService({ name: serviceName, description: 'API monitor', category: 'Monitor' });

                await api.createMonitor({
                    service_id: service.id,
                    monitor_type: 'api',
                    config: {
                        url: document.getElementById('apiUrl').value,
                        method: document.getElementById('apiMethod').value,
                        expected_status_code: parseInt(document.getElementById('apiStatusCode').value),
                        timeout_seconds: 10
                    },
                    check_interval_minutes: parseInt(document.getElementById('apiInterval').value)
                });

                hideQuickMonitorModal();
                loadServices();
            } catch (error) {
                alert('Failed to create monitor: ' + error.message);
            }
        }

        async function createMetricMonitor() {
            try {
                const serviceName = document.getElementById('metricServiceName').value;
                const monitorName = document.getElementById('metricMonitorName').value;
                const service = await api.createService({ name: serviceName, description: 'Metric threshold monitor', category: 'Monitor' });

                const config = {
                    warning_threshold: parseFloat(document.getElementById('metricWarning').value),
                    critical_threshold: parseFloat(document.getElementById('metricCritical').value),
                    comparison: document.getElementById('metricComparison').value
                };
                if (monitorName) {
                    config.name = monitorName;
                }

                await api.createMonitor({
                    service_id: service.id,
                    monitor_type: 'metric_threshold',
                    config: config,
                    check_interval_minutes: 15
                });

                hideQuickMonitorModal();
                loadServices();
            } catch (error) {
                alert('Failed to create monitor: ' + error.message);
            }
        }

        async function createPortMonitor() {
            try {
                const serviceName = document.getElementById('portServiceName').value;
                const service = await api.createService({ name: serviceName, description: 'Port monitor', category: 'Monitor' });

                await api.createMonitor({
                    service_id: service.id,
                    monitor_type: 'port',
                    config: {
                        host: document.getElementById('portHost').value,
                        port: parseInt(document.getElementById('portPort').value),
                        timeout_seconds: 5
                    },
                    check_interval_minutes: parseInt(document.getElementById('portInterval').value)
                });

                hideQuickMonitorModal();
                loadServices();
            } catch (error) {
                alert('Failed to create monitor: ' + error.message);
            }
        }

        async function createDeadmanMonitor() {
            try {
                const serviceName = document.getElementById('deadmanServiceName').value;
                const monitorName = document.getElementById('deadmanMonitorName').value;
                const service = await api.createService({ name: serviceName, description: 'Deadman monitor', category: 'Monitor' });

                const config = {
                    expected_interval_hours: parseFloat(document.getElementById('deadmanExpectedInterval').value),
                    grace_period_hours: parseFloat(document.getElementById('deadmanGracePeriod').value)
                };
                if (monitorName) {
                    config.name = monitorName;
                }

                await api.createMonitor({
                    service_id: service.id,
                    monitor_type: 'deadman',
                    config: config,
                    check_interval_minutes: 5
                });

                hideQuickMonitorModal();
                loadServices();
            } catch (error) {
                alert('Failed to create monitor: ' + error.message);
            }
        }

        async function deleteService(id) {
            if (!confirm('Are you sure you want to delete this service and all its monitors?')) return;
            try {
                await api.deleteService(id);
                loadServices();
            } catch (error) {
                alert('Failed to delete service: ' + error.message);
            }
        }

        async function deleteMonitor(id) {
            if (!confirm('Are you sure you want to delete this monitor?')) return;
            try {
                await api.deleteMonitor(id);
                loadServices();
            } catch (error) {
                alert('Failed to delete monitor: ' + error.message);
            }
        }

        // Add Monitor to Existing Service functions
        function showAddMonitorToServiceModal(serviceId, serviceName) {
            document.getElementById('targetServiceId').value = serviceId;
            document.getElementById('targetServiceName').textContent = serviceName;
            document.getElementById('addMonitorToServiceModal').classList.remove('hidden');
        }

        function hideAddMonitorToServiceModal() {
            document.getElementById('addMonitorToServiceModal').classList.add('hidden');
            backToAddMonitorSelection();
        }

        function selectAddMonitorType(type) {
            document.getElementById('addMonitorTypeSelection').classList.add('hidden');

            // Map monitor type to form ID
            const formIds = {
                'website': 'addWebsiteMonitorForm',
                'api': 'addApiMonitorForm',
                'metric_threshold': 'addMetricMonitorForm',
                'port': 'addPortMonitorForm',
                'deadman': 'addDeadmanMonitorForm'
            };

            document.getElementById(formIds[type]).classList.remove('hidden');

            // Update service name preview for metric and deadman monitors
            if (type === 'metric_threshold') {
                const serviceName = document.getElementById('targetServiceName').textContent;
                document.getElementById('addMetricServiceNamePreview').textContent = serviceName;
            } else if (type === 'deadman') {
                const serviceName = document.getElementById('targetServiceName').textContent;
                document.getElementById('addDeadmanServiceNamePreview').textContent = serviceName;
            }
        }

        function backToAddMonitorSelection() {
            document.getElementById('addMonitorTypeSelection').classList.remove('hidden');
            document.getElementById('addWebsiteMonitorForm').classList.add('hidden');
            document.getElementById('addApiMonitorForm').classList.add('hidden');
            document.getElementById('addMetricMonitorForm').classList.add('hidden');
            document.getElementById('addPortMonitorForm').classList.add('hidden');
            document.getElementById('addDeadmanMonitorForm').classList.add('hidden');
        }

        async function addWebsiteMonitorToService() {
            try {
                const serviceId = parseInt(document.getElementById('targetServiceId').value);

                await api.createMonitor({
                    service_id: serviceId,
                    monitor_type: 'website',
                    config: {
                        url: document.getElementById('addWebsiteUrl').value,
                        timeout_seconds: parseInt(document.getElementById('addWebsiteTimeout').value),
                        follow_redirects: true,
                        verify_ssl: true
                    },
                    check_interval_minutes: parseInt(document.getElementById('addWebsiteInterval').value)
                });

                hideAddMonitorToServiceModal();
                loadServices();
            } catch (error) {
                alert('Failed to add monitor: ' + error.message);
            }
        }

        async function addApiMonitorToService() {
            try {
                const serviceId = parseInt(document.getElementById('targetServiceId').value);

                await api.createMonitor({
                    service_id: serviceId,
                    monitor_type: 'api',
                    config: {
                        url: document.getElementById('addApiUrl').value,
                        method: document.getElementById('addApiMethod').value,
                        expected_status_code: parseInt(document.getElementById('addApiStatusCode').value),
                        timeout_seconds: 10
                    },
                    check_interval_minutes: parseInt(document.getElementById('addApiInterval').value)
                });

                hideAddMonitorToServiceModal();
                loadServices();
            } catch (error) {
                alert('Failed to add monitor: ' + error.message);
            }
        }

        async function addMetricMonitorToService() {
            try {
                const serviceId = parseInt(document.getElementById('targetServiceId').value);
                const serviceName = document.getElementById('targetServiceName').textContent;
                const monitorName = document.getElementById('addMetricMonitorName').value;

                const config = {
                    warning_threshold: parseFloat(document.getElementById('addMetricWarning').value),
                    critical_threshold: parseFloat(document.getElementById('addMetricCritical').value),
                    comparison: document.getElementById('addMetricComparison').value
                };
                if (monitorName) {
                    config.name = monitorName;
                }

                await api.createMonitor({
                    service_id: serviceId,
                    monitor_type: 'metric_threshold',
                    config: config,
                    check_interval_minutes: 15
                });

                hideAddMonitorToServiceModal();
                loadServices();
                const endpoint = monitorName ? `/api/v1/metric/${serviceName}/${monitorName}` : `/api/v1/metric/${serviceName}`;
                alert(`Metric monitor added successfully! Send values to: POST ${endpoint}`);
            } catch (error) {
                alert('Failed to add monitor: ' + error.message);
            }
        }

        async function addPortMonitorToService() {
            try {
                const serviceId = parseInt(document.getElementById('targetServiceId').value);

                await api.createMonitor({
                    service_id: serviceId,
                    monitor_type: 'port',
                    config: {
                        host: document.getElementById('addPortHost').value,
                        port: parseInt(document.getElementById('addPortNumber').value),
                        timeout_seconds: 5
                    },
                    check_interval_minutes: parseInt(document.getElementById('addPortInterval').value)
                });

                hideAddMonitorToServiceModal();
                loadServices();
            } catch (error) {
                alert('Failed to add monitor: ' + error.message);
            }
        }

        async function addDeadmanMonitorToService() {
            try {
                const serviceId = parseInt(document.getElementById('targetServiceId').value);
                const serviceName = document.getElementById('targetServiceName').textContent;
                const monitorName = document.getElementById('addDeadmanMonitorName').value;

                const config = {
                    expected_interval_hours: parseFloat(document.getElementById('addDeadmanExpectedInterval').value),
                    grace_period_hours: parseFloat(document.getElementById('addDeadmanGracePeriod').value)
                };
                if (monitorName) {
                    config.name = monitorName;
                }

                await api.createMonitor({
                    service_id: serviceId,
                    monitor_type: 'deadman',
                    config: config,
                    check_interval_minutes: 5
                });

                hideAddMonitorToServiceModal();
                loadServices();
                const endpoint = monitorName ? `/api/v1/heartbeat/${serviceName}/${monitorName}` : `/api/v1/heartbeat/${serviceName}`;
                alert(`Deadman monitor added successfully! Send heartbeats to: POST ${endpoint}`);
            } catch (error) {
                alert('Failed to add monitor: ' + error.message);
            }
        }

        async function editMonitor(monitorId) {
            try {
                const monitor = await api.getMonitor(monitorId);

                // Fetch service name for metric and deadman monitors
                let serviceName = '';
                if (monitor.monitor_type === 'metric_threshold' || monitor.monitor_type === 'deadman') {
                    const service = await api.getService(monitor.service_id);
                    serviceName = service.name;
                }

                if (monitor.monitor_type === 'website') {
                    document.getElementById('editWebsiteMonitorId').value = monitor.id;
                    document.getElementById('editWebsiteUrl').value = monitor.config.url;
                    document.getElementById('editWebsiteInterval').value = monitor.check_interval_minutes;
                    document.getElementById('editWebsiteTimeout').value = monitor.config.timeout_seconds || 10;
                    document.getElementById('editWebsiteMonitorModal').classList.remove('hidden');
                } else if (monitor.monitor_type === 'api') {
                    document.getElementById('editApiMonitorId').value = monitor.id;
                    document.getElementById('editApiUrl').value = monitor.config.url;
                    document.getElementById('editApiMethod').value = monitor.config.method || 'GET';
                    document.getElementById('editApiStatusCode').value = monitor.config.expected_status_code || 200;
                    document.getElementById('editApiInterval').value = monitor.check_interval_minutes;
                    document.getElementById('editApiMonitorModal').classList.remove('hidden');
                } else if (monitor.monitor_type === 'metric_threshold') {
                    document.getElementById('editMetricMonitorId').value = monitor.id;
                    document.getElementById('editMetricMonitorName').value = monitor.config.name || '';
                    document.getElementById('editMetricWarning').value = monitor.config.warning_threshold;
                    document.getElementById('editMetricCritical').value = monitor.config.critical_threshold;
                    document.getElementById('editMetricComparison').value = monitor.config.comparison || 'greater';
                    // Update endpoint preview to include monitor name if present
                    const metricEndpoint = monitor.config.name ? `${serviceName}/${monitor.config.name}` : serviceName;
                    document.getElementById('editMetricServiceNamePreview').textContent = metricEndpoint;
                    document.getElementById('editMetricMonitorModal').classList.remove('hidden');
                } else if (monitor.monitor_type === 'port') {
                    document.getElementById('editPortMonitorId').value = monitor.id;
                    document.getElementById('editPortHost').value = monitor.config.host;
                    document.getElementById('editPortNumber').value = monitor.config.port;
                    document.getElementById('editPortInterval').value = monitor.check_interval_minutes;
                    document.getElementById('editPortMonitorModal').classList.remove('hidden');
                } else if (monitor.monitor_type === 'deadman') {
                    document.getElementById('editDeadmanMonitorId').value = monitor.id;
                    document.getElementById('editDeadmanMonitorName').value = monitor.config.name || '';
                    document.getElementById('editDeadmanExpectedInterval').value = monitor.config.expected_interval_hours;
                    document.getElementById('editDeadmanGracePeriod').value = monitor.config.grace_period_hours;
                    // Update endpoint preview to include monitor name if present
                    const deadmanEndpoint = monitor.config.name ? `${serviceName}/${monitor.config.name}` : serviceName;
                    document.getElementById('editDeadmanServiceNamePreview').textContent = deadmanEndpoint;
                    document.getElementById('editDeadmanMonitorModal').classList.remove('hidden');
                }
            } catch (error) {
                alert('Failed to load monitor: ' + error.message);
            }
        }

        function hideEditMonitorModal() {
            document.getElementById('editWebsiteMonitorModal').classList.add('hidden');
            document.getElementById('editApiMonitorModal').classList.add('hidden');
            document.getElementById('editMetricMonitorModal').classList.add('hidden');
            document.getElementById('editPortMonitorModal').classList.add('hidden');
            document.getElementById('editDeadmanMonitorModal').classList.add('hidden');
        }

        // Edit monitor form submit handlers
        document.getElementById('editWebsiteMonitorForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const monitorId = document.getElementById('editWebsiteMonitorId').value;

            try {
                await api.updateMonitor(monitorId, {
                    config: {
                        url: document.getElementById('editWebsiteUrl').value,
                        timeout_seconds: parseInt(document.getElementById('editWebsiteTimeout').value),
                        follow_redirects: true,
                        verify_ssl: true
                    },
                    check_interval_minutes: parseInt(document.getElementById('editWebsiteInterval').value)
                });

                hideEditMonitorModal();
                loadServices();
            } catch (error) {
                alert('Failed to update monitor: ' + error.message);
            }
        });

        document.getElementById('editApiMonitorForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const monitorId = document.getElementById('editApiMonitorId').value;

            try {
                await api.updateMonitor(monitorId, {
                    config: {
                        url: document.getElementById('editApiUrl').value,
                        method: document.getElementById('editApiMethod').value,
                        expected_status_code: parseInt(document.getElementById('editApiStatusCode').value),
                        timeout_seconds: 10
                    },
                    check_interval_minutes: parseInt(document.getElementById('editApiInterval').value)
                });

                hideEditMonitorModal();
                loadServices();
            } catch (error) {
                alert('Failed to update monitor: ' + error.message);
            }
        });

        document.getElementById('editMetricMonitorForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const monitorId = document.getElementById('editMetricMonitorId').value;
            const monitorName = document.getElementById('editMetricMonitorName').value;

            try {
                const config = {
                    warning_threshold: parseFloat(document.getElementById('editMetricWarning').value),
                    critical_threshold: parseFloat(document.getElementById('editMetricCritical').value),
                    comparison: document.getElementById('editMetricComparison').value
                };
                if (monitorName) {
                    config.name = monitorName;
                }

                await api.updateMonitor(monitorId, {
                    config: config
                });

                hideEditMonitorModal();
                loadServices();
            } catch (error) {
                alert('Failed to update monitor: ' + error.message);
            }
        });

        document.getElementById('editPortMonitorForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const monitorId = document.getElementById('editPortMonitorId').value;

            try {
                await api.updateMonitor(monitorId, {
                    config: {
                        host: document.getElementById('editPortHost').value,
                        port: parseInt(document.getElementById('editPortNumber').value),
                        timeout_seconds: 5
                    },
                    check_interval_minutes: parseInt(document.getElementById('editPortInterval').value)
                });

                hideEditMonitorModal();
                loadServices();
            } catch (error) {
                alert('Failed to update monitor: ' + error.message);
            }
        });

        document.getElementById('editDeadmanMonitorForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const monitorId = document.getElementById('editDeadmanMonitorId').value;
            const monitorName = document.getElementById('editDeadmanMonitorName').value;

            try {
                const config = {
                    expected_interval_hours: parseFloat(document.getElementById('editDeadmanExpectedInterval').value),
                    grace_period_hours: parseFloat(document.getElementById('editDeadmanGracePeriod').value)
                };
                if (monitorName) {
                    config.name = monitorName;
                }

                await api.updateMonitor(monitorId, {
                    config: config
                });

                hideEditMonitorModal();
                loadServices();
            } catch (error) {
                alert('Failed to update monitor: ' + error.message);
            }
        });

        // Update service name preview in Quick Monitor API examples
        document.getElementById('metricServiceName').addEventListener('input', (e) => {
            const serviceName = e.target.value || 'SERVICE_NAME';
            const monitorName = document.getElementById('metricMonitorName').value;
            const preview = monitorName ? `${serviceName}/${monitorName}` : serviceName;
            document.getElementById('quickMetricServicePreview').textContent = preview;
        });

        document.getElementById('metricMonitorName').addEventListener('input', (e) => {
            const serviceName = document.getElementById('metricServiceName').value || 'SERVICE_NAME';
            const monitorName = e.target.value;
            const preview = monitorName ? `${serviceName}/${monitorName}` : serviceName;
            document.getElementById('quickMetricServicePreview').textContent = preview;
        });

        document.getElementById('deadmanServiceName').addEventListener('input', (e) => {
            const serviceName = e.target.value || 'SERVICE_NAME';
            const monitorName = document.getElementById('deadmanMonitorName').value;
            const preview = monitorName ? `${serviceName}/${monitorName}` : serviceName;
            document.getElementById('quickDeadmanServicePreview').textContent = preview;
        });

        document.getElementById('deadmanMonitorName').addEventListener('input', (e) => {
            const serviceName = document.getElementById('deadmanServiceName').value || 'SERVICE_NAME';
            const monitorName = e.target.value;
            const preview = monitorName ? `${serviceName}/${monitorName}` : serviceName;
            document.getElementById('quickDeadmanServicePreview').textContent = preview;
        });

        // Close modals on background click
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.add('hidden');
                }
            });
        });

        loadServices();
    </script>
</body>
</html>
