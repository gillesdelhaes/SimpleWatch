<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Services - SimpleWatch</title>
    <link rel="stylesheet" href="/static/css/theme.css">
    <link rel="stylesheet" href="/static/css/services.css">
</head>
<body>
    <div id="navigation" data-page="services"></div>

    <div class="main-container">
        <div class="page-header">
            <div>
                <h1 class="page-title">Services & Monitors</h1>
                <p style="color: var(--text-secondary); margin-top: 0.5rem;">Manage your monitoring services and checks</p>
            </div>
            <div class="action-buttons">
                <button onclick="showAddServiceModal()" class="btn btn-secondary">+ Add Service</button>
                <button onclick="showQuickMonitorModal()" class="btn btn-export" id="quickMonitorBtn">
                    Quick Monitor
                </button>
            </div>
        </div>

        <div id="servicesList"></div>
    </div>

    <!-- Add Service Modal -->
    <div id="addServiceModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Add Service</h3>
            </div>
            <form id="addServiceForm">
                <div class="form-group">
                    <label class="form-label">Service Name</label>
                    <input type="text" id="serviceName" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea id="serviceDescription" class="form-input" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Category</label>
                    <input type="text" id="serviceCategory" class="form-input">
                </div>
                <div style="display: flex; gap: 1rem;">
                    <button type="submit" class="btn btn-primary" style="flex: 1;">Create</button>
                    <button type="button" onclick="hideAddServiceModal()" class="btn btn-secondary" style="flex: 1;">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Service Modal -->
    <div id="editServiceModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Edit Service</h3>
            </div>
            <form id="editServiceForm">
                <input type="hidden" id="editServiceId">
                <div class="form-group">
                    <label class="form-label">Service Name</label>
                    <input type="text" id="editServiceName" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea id="editServiceDescription" class="form-input" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Category</label>
                    <input type="text" id="editServiceCategory" class="form-input">
                </div>

                <!-- Notification Settings Section -->
                <div style="border-top: 1px solid var(--border-color); margin-top: 2rem; padding-top: 2rem;">
                    <h4 style="font-weight: 700; margin-bottom: 1rem; color: var(--text-primary); display: flex; align-items: center; gap: 0.5rem;">
                        <span class="icon icon-lg" style="color: var(--accent-primary);" innerHTML="${icons.bell}"></span>
                        Notification Settings
                    </h4>

                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="editNotificationsEnabled" class="form-checkbox" checked>
                            <span>Enable notifications for this service</span>
                        </label>
                    </div>

                    <div id="notificationSettingsContent">
                        <div class="form-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="editEmailEnabled" class="form-checkbox">
                                <span>Send email notifications</span>
                            </label>
                        </div>

                        <div class="form-group" id="emailRecipientsGroup" style="display: none;">
                            <label class="form-label">Email Recipients (comma-separated)</label>
                            <input type="text" id="editEmailRecipients" class="form-input" placeholder="admin@example.com, ops@example.com">
                        </div>

                        <div class="form-group">
                            <label class="form-label">Webhook Channels</label>
                            <div id="webhookChannelsList" style="font-size: 0.875rem; color: var(--text-secondary);">
                                Loading channels...
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Cooldown Period (minutes)</label>
                            <input type="number" id="editCooldownMinutes" class="form-input" value="5" min="1">
                            <div style="font-size: 0.75rem; color: var(--text-tertiary); margin-top: 0.5rem;">
                                Minimum time between notifications to prevent spam
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="editNotifyOnRecovery" class="form-checkbox" checked>
                                <span>Send recovery notifications</span>
                            </label>
                        </div>
                    </div>
                </div>

                <div style="display: flex; gap: 1rem;">
                    <button type="submit" class="btn btn-primary" style="flex: 1;">Update</button>
                    <button type="button" onclick="hideEditServiceModal()" class="btn btn-secondary" style="flex: 1;">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Quick Monitor Modal -->
    <div id="quickMonitorModal" class="modal hidden">
        <div class="modal-content large">
            <div class="modal-header">
                <div>
                    <h3 class="modal-title">Quick Monitor Setup</h3>
                    <p class="modal-subtitle">Create a service and monitor in one step</p>
                </div>
            </div>

            <!-- Type Selection Screen -->
            <div id="monitorTypeSelection">
                <h4 style="font-weight: 700; margin-bottom: 1rem; color: var(--text-primary);">Select Monitor Type</h4>
                <div id="quickMonitorTypeGrid" class="type-grid">
                    <!-- Cards will be injected here by registry -->
                </div>
                <button onclick="hideQuickMonitorModal()" class="btn btn-secondary" style="width: 100%;">Cancel</button>
            </div>

            <!-- Monitor Configuration Form (dynamically generated) -->
            <div id="monitorConfigForm" class="hidden">
                <button onclick="backToMonitorSelection()" class="btn btn-secondary" style="margin-bottom: 1rem;">← Back</button>
                <h4 id="monitorFormTitle" style="font-weight: 700; margin-bottom: 1rem;"></h4>
                <form id="quickMonitorForm" onsubmit="handleQuickMonitorSubmit(event)">
                    <div id="quickMonitorFormFields">
                        <!-- Fields will be injected here -->
                    </div>
                    <button type="submit" class="btn btn-primary" style="width: 100%;">Create Monitor</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Add Monitor to Service Modal -->
    <div id="addMonitorToServiceModal" class="modal hidden">
        <div class="modal-content large">
            <div class="modal-header">
                <div>
                    <h3 class="modal-title">Add Monitor to Service</h3>
                    <p class="modal-subtitle">Service: <span id="targetServiceName"></span></p>
                </div>
            </div>
            <input type="hidden" id="targetServiceId">

            <!-- Type Selection Screen -->
            <div id="addMonitorTypeSelection">
                <h4 style="font-weight: 700; margin-bottom: 1rem; color: var(--text-primary);">Select Monitor Type</h4>
                <div id="addMonitorTypeGrid" class="type-grid">
                    <!-- Cards will be injected here by registry -->
                </div>
                <button onclick="hideAddMonitorToServiceModal()" class="btn btn-secondary" style="width: 100%; margin-top: 1rem;">Cancel</button>
            </div>

            <!-- Monitor Configuration Form (dynamically generated) -->
            <div id="addMonitorConfigForm" class="hidden">
                <button onclick="backToAddMonitorSelection()" class="btn btn-secondary" style="margin-bottom: 1rem;">← Back</button>
                <h4 id="addMonitorFormTitle" style="font-weight: 700; margin-bottom: 1rem;"></h4>
                <form id="addMonitorForm" onsubmit="handleAddMonitorSubmit(event)">
                    <div id="addMonitorFormFields">
                        <!-- Fields will be injected here -->
                    </div>
                    <button type="submit" class="btn btn-primary" style="width: 100%;">Add Monitor</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Edit Monitor Modal (Generic, plugin-based) -->
    <div id="editMonitorModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="editMonitorTitle">Edit Monitor</h3>
            </div>
            <form id="editMonitorForm" onsubmit="handleEditMonitorSubmit(event)">
                <input type="hidden" id="editMonitorId">
                <input type="hidden" id="editMonitorType">
                <input type="hidden" id="editMonitorServiceId">
                <input type="hidden" id="editMonitorServiceName">
                <div id="editMonitorFormFields">
                    <!-- Fields will be injected here by registry -->
                </div>
                <div style="display: flex; gap: 1rem;">
                    <button type="submit" class="btn btn-primary" style="flex: 1;">Update</button>
                    <button type="button" onclick="hideEditMonitorModal()" class="btn btn-secondary" style="flex: 1;">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <script src="/static/js/components.js"></script>
    <script src="/static/js/theme.js"></script>
    <script src="/static/js/api.js"></script>
    <script src="/static/js/auth.js"></script>
    <script src="/static/js/nav.js"></script>

    <!-- Monitor Plugin System -->
    <script type="module">
        import monitorRegistry from '/static/js/monitors/registry.js';

        // Store current Quick Monitor type globally
        window.currentQuickMonitorType = null;

        // Make registry available globally
        window.monitorRegistry = monitorRegistry;

        // Initialize plugin system on page load
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // Load all monitor plugins
                await monitorRegistry.loadMonitors();

                // Render Quick Monitor type cards
                const quickMonitorTypeGrid = document.getElementById('quickMonitorTypeGrid');
                if (quickMonitorTypeGrid) {
                    quickMonitorTypeGrid.innerHTML = monitorRegistry.renderTypeCards('selectMonitorType');
                }

                // Render Add Monitor type cards (if needed later)
                const addMonitorTypeGrid = document.getElementById('addMonitorTypeGrid');
                if (addMonitorTypeGrid) {
                    addMonitorTypeGrid.innerHTML = monitorRegistry.renderTypeCards('selectAddMonitorType');
                }

                // Dispatch event to signal plugins are ready
                window.dispatchEvent(new CustomEvent('monitorPluginsLoaded'));
            } catch (error) {
                console.error('Failed to initialize monitor plugin system:', error);
            }
        });
    </script>

    <script src="/static/js/services.js"></script>
</body>
</html>
